<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Control - Citas Peluquer√≠a</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; 
      padding: 20px; 
      min-height: 100vh;
    }
    .panel-container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: rgba(255,255,255,0.95); 
      border-radius: 15px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
      padding: 30px;
      backdrop-filter: blur(10px);
    }
    h1 { 
      color: #2196f3; 
      text-align: center; 
      margin-bottom: 30px;
      font-size: 28px;
    }
    .calendario-semanal {
      display: grid;
      grid-template-columns: 80px repeat(7, 1fr);
      gap: 2px;
      margin-top: 20px;
    }
    
    .calendario-diario {
      display: none;
      margin-top: 20px;
    }
    
    .dia-header {
      background: #2196f3;
      color: white;
      padding: 20px;
      text-align: center;
      border-radius: 10px 10px 0 0;
      font-size: 18px;
      font-weight: bold;
    }
    
    .horas-lista {
      background: white;
      border-radius: 0 0 10px 10px;
      overflow: hidden;
    }
    
    .hora-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }
    
    .hora-item:last-child {
      border-bottom: none;
    }
    
    .hora-item.libre {
      background: #e8f5e8;
    }
    
    .hora-item.ocupada {
      background: #ffebee;
    }
    
    .hora-item.cerrado {
      background: #f5f5f5;
      color: #999;
    }
    
    .hora-texto {
      font-weight: bold;
      font-size: 16px;
    }
    
    .cita-detalle {
      text-align: right;
      font-size: 14px;
    }
    
    .cita-nombre-mobile {
      font-weight: bold;
      color: #1565c0;
      display: block;
    }
    
    .cita-servicio-mobile {
      color: #666;
      font-size: 12px;
    }
    
    .dia-selector {
      display: none;
      margin-bottom: 20px;
    }
    
    .dia-btn {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      margin: 0 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .dia-btn:hover {
      background: #1976d2;
    }
    
    .dia-btn.activo {
      background: #1565c0;
    }
    .header-dia {
      background: #2196f3;
      color: white;
      padding: 15px 8px;
      text-align: center;
      font-weight: bold;
      border-radius: 8px 8px 0 0;
      font-size: 14px;
    }
    .header-hora {
      background: #f5f5f5;
      color: #333;
      padding: 6px 5px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
      border-right: 1px solid #ddd;
    }
    .celda-hora {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      padding: 4px 5px;
      text-align: center;
      font-size: 11px;
      min-height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .celda-hora.libre {
      background: #e8f5e8;
      color: #2e7d32;
    }
    .celda-hora.ocupada {
      background: #ffebee;
      color: #c62828;
      font-weight: bold;
    }
    .cita-info {
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      background: rgba(255,255,255,0.95);
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 10px;
      line-height: 1.2;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .cita-nombre {
      font-weight: bold;
      color: #1565c0;
    }
    .cita-servicio {
      color: #666;
      font-size: 9px;
    }
    .controles {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }
    .btn-nav {
      background: #2196f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-nav:hover {
      background: #1976d2;
      transform: translateY(-2px);
    }
    .semana-actual {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      min-width: 200px;
      text-align: center;
    }
    .resumen {
      background: #e3f2fd;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }
    .resumen h3 {
      color: #1565c0;
      margin-top: 0;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .stat-numero {
      font-size: 24px;
      font-weight: bold;
      color: #2196f3;
    }
    .stat-label {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    
    /* Responsive para m√≥vil */
    @media (max-width: 768px) {
      .panel-container {
        margin: 10px;
        padding: 20px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      .calendario-semanal {
        display: none;
      }
      
      .calendario-diario {
        display: block;
      }
      
      .dia-selector {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .dia-btn {
        padding: 10px 15px;
        font-size: 14px;
        margin: 0 2px;
      }
      
      .controles {
        flex-direction: column;
        gap: 15px;
      }
      
      .semana-actual {
        font-size: 16px;
        min-width: auto;
      }
      
      .stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .stat {
        padding: 12px;
      }
      
      .stat-numero {
        font-size: 20px;
      }
      
      .stat-label {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="panel-container">
    <h1>üìÖ Panel de Control de Citas</h1>
    
    <div class="controles">
      <button class="btn-nav" onclick="cambiarSemana(-1)">‚Üê Semana Anterior</button>
      <div class="semana-actual" id="semana-actual"></div>
      <button class="btn-nav" onclick="cambiarSemana(1)">Semana Siguiente ‚Üí</button>
    </div>

    <div class="calendario-semanal" id="calendario">
      <!-- Se llena din√°micamente -->
    </div>

    <div class="dia-selector" id="dia-selector">
      <!-- Se llena din√°micamente -->
    </div>

    <div class="calendario-diario" id="calendario-diario">
      <div class="dia-header" id="dia-header">
        <!-- Se llena din√°micamente -->
      </div>
      <div class="horas-lista" id="horas-lista">
        <!-- Se llena din√°micamente -->
      </div>
    </div>

    <div class="resumen">
      <h3>üìä Resumen de la Semana</h3>
      <div class="stats" id="stats">
        <!-- Se llena din√°micamente -->
      </div>
    </div>

    <!-- Botones de desarrollo para generar citas de prueba -->
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px dashed #dee2e6;">
      <h4 style="color: #6c757d; margin-top: 0;">üõ†Ô∏è Herramientas de Desarrollo</h4>
      <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <button onclick="generarCitasPrueba()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
          üé≤ Generar Citas de Prueba
        </button>
        <button onclick="limpiarCitas()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
          üóëÔ∏è Limpiar Todas las Citas
        </button>
      </div>
      <div id="mensaje-desarrollo" style="margin-top: 10px; font-size: 14px; color: #6c757d;"></div>
    </div>
  </div>

  <script>
    const HORAS = [
      '10:00', '10:30', '11:00', '11:30',
      '12:00', '12:30', '13:00', '13:30',
      '16:00', '16:30', '17:00', '17:30',
      '18:00', '18:30', '19:00', '19:30'
    ];
    
    let semanaActual = new Date();
    semanaActual.setDate(semanaActual.getDate() - semanaActual.getDay() + 1); // Lunes
    let diaActual = new Date();
    
    // Debug: mostrar la semana que se est√° cargando
    console.log('üìÖ Semana actual cargada:', semanaActual.toISOString().split('T')[0]);

    function formatearFecha(fecha) {
      const dia = fecha.getDate().toString().padStart(2, '0');
      const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
      const anio = fecha.getFullYear();
      return `${dia}/${mes}/${anio}`;
    }

    function formatearFechaAPI(fecha) {
      return fecha.toISOString().split('T')[0];
    }

    function obtenerNombreDia(fecha) {
      const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
      return dias[fecha.getDay()];
    }

    function obtenerDiaSemana(fecha) {
      const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
      return dias[fecha.getDay()];
    }

    function cambiarSemana(direccion) {
      semanaActual.setDate(semanaActual.getDate() + (direccion * 7));
      cargarCalendario();
    }

    function cambiarDia(direccion) {
      diaActual.setDate(diaActual.getDate() + direccion);
      cargarCalendarioDiario();
    }

    function seleccionarDia(fecha) {
      diaActual = new Date(fecha);
      cargarCalendarioDiario();
    }

    async function cargarCalendario() {
      const calendario = document.getElementById('calendario');
      const semanaActualDiv = document.getElementById('semana-actual');
      
      // Actualizar t√≠tulo de la semana
      const finSemana = new Date(semanaActual);
      finSemana.setDate(finSemana.getDate() + 6);
      semanaActualDiv.textContent = `${formatearFecha(semanaActual)} - ${formatearFecha(finSemana)}`;

      // Crear encabezados de d√≠as
      let html = '<div class="header-hora">Hora</div>';
      for (let i = 0; i < 7; i++) {
        const dia = new Date(semanaActual);
        dia.setDate(dia.getDate() + i);
        html += `<div class="header-dia">${obtenerNombreDia(dia)}<br>${dia.getDate()}</div>`;
      }

      // Crear filas de horas
      for (const hora of HORAS) {
        html += `<div class="header-hora">${hora}</div>`;
        
        for (let i = 0; i < 7; i++) {
          const dia = new Date(semanaActual);
          dia.setDate(dia.getDate() + i);
          const fechaStr = formatearFecha(dia);
          
          // Verificar si es domingo (d√≠a cerrado)
          if (dia.getDay() === 0) {
            html += `<div class="celda-hora" style="background:#f0f0f0; color:#999;">Cerrado</div>`;
          } else {
            html += `<div class="celda-hora libre" data-fecha="${fechaStr}" data-hora="${hora}">Libre</div>`;
          }
        }
      }

      calendario.innerHTML = html;

      // Cargar datos de citas para toda la semana
      await cargarCitasSemana();
    }

    async function cargarCitasSemana() {
      const celdas = document.querySelectorAll('.celda-hora[data-fecha]');
      const citasSemana = [];

      // Cargar citas para cada d√≠a de la semana
      for (let i = 0; i < 7; i++) {
        const dia = new Date(semanaActual);
        dia.setDate(dia.getDate() + i);
        const fechaStr = formatearFecha(dia);
        
        console.log(`üîç D√≠a ${i}: ${fechaStr} (${obtenerNombreDia(dia)})`);
        
        if (dia.getDay() !== 0) { // No domingo
          try {
            const fechaAPI = formatearFechaAPI(dia);
            console.log(`üîç Consultando citas para: ${fechaAPI} (${fechaStr})`);
            
            const res = await fetch('/citas_dia', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ dia: fechaAPI })
            });
            const data = await res.json();
            console.log(`üìÖ Citas encontradas para ${fechaAPI}:`, data.citas);
            citasSemana.push(...data.citas);
            
            // Actualizar celdas con citas
            data.citas.forEach(cita => {
              const celda = document.querySelector(`[data-fecha="${fechaStr}"][data-hora="${cita.hora}"]`);
              console.log(`üîç Buscando celda: ${fechaStr} ${cita.hora} - Encontrada: ${celda ? 'S√ç' : 'NO'}`);
              if (celda) {
                celda.className = 'celda-hora ocupada';
                celda.innerHTML = `
                  <div class="cita-info" onclick="mostrarOpcionesCita('${cita.nombre}', '${cita.servicio}', '${fechaStr}', '${cita.hora}', '${cita.telefono}')">
                    <div class="cita-nombre">${cita.nombre}</div>
                    <div class="cita-servicio">${cita.servicio}</div>
                  </div>
                `;
              }
            });
          } catch (error) {
            console.error('Error cargando citas:', error);
          }
        }
      }

      // Actualizar estad√≠sticas
      actualizarEstadisticas(citasSemana);
      
      // Cargar vista diaria si es m√≥vil
      if (window.innerWidth <= 768) {
        cargarCalendarioDiario();
      }
    }

    async function cargarCalendarioDiario() {
      const diaHeader = document.getElementById('dia-header');
      const horasLista = document.getElementById('horas-lista');
      const diaSelector = document.getElementById('dia-selector');
      
      // Actualizar header del d√≠a
      const nombreDia = obtenerDiaSemana(diaActual);
      const fechaStr = formatearFecha(diaActual);
      diaHeader.textContent = `${nombreDia}, ${diaActual.getDate()} de ${diaActual.toLocaleDateString('es-ES', {month: 'long'})}`;
      
      // Crear selector de d√≠as para la semana
      let selectorHtml = '';
      for (let i = 0; i < 7; i++) {
        const dia = new Date(semanaActual);
        dia.setDate(dia.getDate() + i);
        const diaFechaStr = formatearFecha(dia);
        const esActivo = diaFechaStr === fechaStr;
        const esDomingo = dia.getDay() === 0;
        
        if (!esDomingo) {
          selectorHtml += `<button class="dia-btn ${esActivo ? 'activo' : ''}" onclick="seleccionarDia('${diaFechaStr}')">${obtenerNombreDia(dia)} ${dia.getDate()}</button>`;
        }
      }
      diaSelector.innerHTML = selectorHtml;
      
      // Crear lista de horas
      let horasHtml = '';
      
      try {
        const res = await fetch('/citas_dia', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dia: formatearFechaAPI(diaActual) })
        });
        const data = await res.json();
        
        for (const hora of HORAS) {
          const cita = data.citas.find(c => c.hora === hora);
          let clase = 'hora-item libre';
          let contenido = `<div class="hora-texto">${hora}</div><div class="cita-detalle">Libre</div>`;
          
          if (cita) {
            clase = 'hora-item ocupada';
            contenido = `
              <div class="hora-texto">${hora}</div>
              <div class="cita-detalle">
                <span class="cita-nombre-mobile">${cita.nombre}</span>
                <span class="cita-servicio-mobile">${cita.servicio}</span>
              </div>
            `;
          }
          
          horasHtml += `<div class="${clase}">${contenido}</div>`;
        }
      } catch (error) {
        console.error('Error cargando citas del d√≠a:', error);
        // Mostrar horas libres por defecto
        for (const hora of HORAS) {
          horasHtml += `<div class="hora-item libre"><div class="hora-texto">${hora}</div><div class="cita-detalle">Libre</div></div>`;
        }
      }
      
      horasLista.innerHTML = horasHtml;
    }

    function actualizarEstadisticas(citas) {
      const stats = document.getElementById('stats');
      
      const totalCitas = citas.length;
      const citasPorServicio = {};
      const citasPorDia = {};
      
      citas.forEach(cita => {
        // Contar por servicio
        citasPorServicio[cita.servicio] = (citasPorServicio[cita.servicio] || 0) + 1;
        
        // Contar por d√≠a
        const dia = obtenerDiaSemana(new Date(cita.dia));
        citasPorDia[dia] = (citasPorDia[dia] || 0) + 1;
      });

      const servicioMasPopular = Object.keys(citasPorServicio).reduce((a, b) => 
        citasPorServicio[a] > citasPorServicio[b] ? a : b, 'N/A');
      
      const diaMasOcupado = Object.keys(citasPorDia).reduce((a, b) => 
        citasPorDia[a] > citasPorDia[b] ? a : b, 'N/A');

      stats.innerHTML = `
        <div class="stat">
          <div class="stat-numero">${totalCitas}</div>
          <div class="stat-label">Total Citas</div>
        </div>
        <div class="stat">
          <div class="stat-numero">${servicioMasPopular}</div>
          <div class="stat-label">Servicio M√°s Popular</div>
        </div>
        <div class="stat">
          <div class="stat-numero">${diaMasOcupado}</div>
          <div class="stat-label">D√≠a M√°s Ocupado</div>
        </div>
        <div class="stat">
          <div class="stat-numero">${Math.round((totalCitas / 7) * 10) / 10}</div>
          <div class="stat-label">Promedio/D√≠a</div>
        </div>
      `;
    }

    function mostrarOpcionesCita(nombre, servicio, fecha, hora, telefono) {
      // Crear modal con opciones
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      const contenido = document.createElement('div');
      contenido.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        text-align: center;
        max-width: 400px;
        width: 90%;
      `;
      
      contenido.innerHTML = `
        <h3 style="margin-top: 0; color: #2196f3;">üìÖ Cita de ${nombre}</h3>
        <p><strong>Servicio:</strong> ${servicio}</p>
        <p><strong>Fecha:</strong> ${fecha}</p>
        <p><strong>Hora:</strong> ${hora}</p>
        <p><strong>Tel√©fono:</strong> ${telefono}</p>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
          <button onclick="contactarWhatsApp('${telefono}', '${nombre}', '${servicio}', '${fecha}', '${hora}')" 
                  style="background: #25d366; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
            üì± WhatsApp
          </button>
          <button onclick="llamarTelefono('${telefono}')" 
                  style="background: #2196f3; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
            üìû Llamar
          </button>
          <button onclick="borrarCita('${fecha}', '${hora}', '${nombre}')" 
                  style="background: #f44336; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
            üóëÔ∏è Borrar
          </button>
        </div>
        
        <button onclick="cerrarModal()" 
                style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin-top: 20px;">
          ‚úï Cerrar
        </button>
      `;
      
      modal.appendChild(contenido);
      document.body.appendChild(modal);
    }

    function cerrarModal() {
      const modal = document.querySelector('div[style*="position: fixed"]');
      if (modal) {
        modal.remove();
      }
    }

    function contactarWhatsApp(telefono, nombre, servicio, fecha, hora) {
      const mensaje = `Hola ${nombre}, te contactamos sobre tu cita de ${servicio} el ${fecha} a las ${hora}. ¬øTodo bien?`;
      const url = `https://wa.me/34${telefono}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
      cerrarModal();
    }

    function llamarTelefono(telefono) {
      window.open(`tel:${telefono}`, '_blank');
      cerrarModal();
    }

    async function borrarCita(fecha, hora, nombre) {
      if (confirm(`¬øEst√°s seguro de que quieres borrar la cita de ${nombre} el ${fecha} a las ${hora}?`)) {
        try {
          const res = await fetch('/borrar_cita', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fecha, hora })
          });
          const data = await res.json();
          if (data.ok) {
            alert('Cita borrada correctamente');
            cargarCitasSemana(); // Recargar el calendario
          } else {
            alert('Error al borrar la cita: ' + data.msg);
          }
        } catch (error) {
          alert('Error al borrar la cita: ' + error);
        }
        cerrarModal();
      }
    }

    // Cargar calendario al iniciar
    document.addEventListener('DOMContentLoaded', function() {
      cargarCalendario();
      
      // Detectar si es m√≥vil y cargar vista diaria
      if (window.innerWidth <= 768) {
        cargarCalendarioDiario();
      }
    });

    // Actualizar cada 30 segundos
    setInterval(function() {
      cargarCitasSemana();
      if (window.innerWidth <= 768) {
        cargarCalendarioDiario();
      }
    }, 30000);

    // Manejar cambio de tama√±o de ventana
    window.addEventListener('resize', function() {
      if (window.innerWidth <= 768) {
        cargarCalendarioDiario();
      }
    });

    // Funci√≥n para generar citas de prueba
    async function generarCitasPrueba() {
      const mensajeDiv = document.getElementById('mensaje-desarrollo');
      mensajeDiv.innerHTML = '‚è≥ Generando citas de prueba...';
      
      try {
        const res = await fetch('/generar_citas_prueba', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        
        if (data.ok) {
          mensajeDiv.innerHTML = `‚úÖ ${data.mensaje}`;
          // Recargar el calendario para mostrar las nuevas citas
          setTimeout(() => {
            cargarCalendario();
            if (window.innerWidth <= 768) {
              cargarCalendarioDiario();
            }
          }, 1000);
        } else {
          mensajeDiv.innerHTML = `‚ùå Error: ${data.error}`;
        }
      } catch (error) {
        mensajeDiv.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
      }
    }

    // Funci√≥n para limpiar todas las citas
    async function limpiarCitas() {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar todas las citas? Esta acci√≥n no se puede deshacer.')) {
        return;
      }
      
      const mensajeDiv = document.getElementById('mensaje-desarrollo');
      mensajeDiv.innerHTML = '‚è≥ Limpiando citas...';
      
      try {
        const res = await fetch('/limpiar_citas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        
        if (data.ok) {
          mensajeDiv.innerHTML = `‚úÖ ${data.mensaje}`;
          // Recargar el calendario para mostrar los cambios
          setTimeout(() => {
            cargarCalendario();
            if (window.innerWidth <= 768) {
              cargarCalendarioDiario();
            }
          }, 1000);
        } else {
          mensajeDiv.innerHTML = `‚ùå Error: ${data.error}`;
        }
      } catch (error) {
        mensajeDiv.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
      }
    }
  </script>
</body>
</html> 